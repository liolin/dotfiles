#!/usr/bin/env bash

logfile=~/.cache/notmuch/notmuch.log

writeLog() {
    echo "$1" >> $logfile
}

exec 2>&1
trap "writeLog \"[FINISH notmuch update - $(date +%Y-%m-%d:%H:%M:%S)]\"" EXIT

writeLog "[START notmuch update - $(date +%Y-%m-%d:%H:%M:%S)]"
/usr/bin/gpg --card-status 
state=$?

if [ $state -ne 0 ]; then
    notify-send --urgency=critical "notmuch" "Could not update mails because of missing key card"
    writeLog "Could not update mails because of missing key card"
    exit $state
fi

/usr/bin/notmuch new | tee -a $logfile 2>&1
lastline=$(/usr/bin/notmuch new 2>&1 | tee -a $logfile | tail -1)
state=$?

if [ $state -ne 0 ]; then
    notify-send --urgency=critical "notmuch" "Could not update mails during an unknown error"
    writeLog "Could not update mails during an unknown error"
else
    if [ "$lastline" != "No new mail." ]; then
	notify-send --urgency=normal "notmuch" "$lastline"
    fi
fi

